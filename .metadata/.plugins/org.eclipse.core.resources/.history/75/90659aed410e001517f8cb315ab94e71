<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="kr.co.taommall.note.dao">
	<sql id="note-select">
		select note_no,title,content,sendId,receiveId,sendDate,read,store
		from note
	</sql>
	
	
	<insert id="insertNote" parameterType="Note">
		<selectKey resultType="int" keyProperty="productId" order="BEFORE">
			select c_note_no.nextval from dual
		</selectKey>
		insert into note 
		(note_no,title,content,send_id,receive_id,send_date,read,store)
		values
		(#{noteNo}, #{title}, #{content}, #{sendId}, #{receiveId}, to_char(sysdate, 'yyyy-mm-dd-hh24-mi'),#{read} ,#{store})
	</insert>
	
	<delete id="deleteNote" parameterType="int">
		delete from note where note_no=#{noteNo}
	</delete>
	
	<resultMap type="note" id="note-resultMap">
		<id column="note_no" property="noteNo"/>
		<result column="title" property="title"/>
		<result column="content" property="content"/>
		<result column="send_id" property="sendId"/>
		<result column="receive_id" property="receiveId"/>
		<result column="send_date" property="sendDate"/>
		<result column="read" property="read"/>
		<result column="store" property="store"/>
	</resultMap>

	
	<!-- 받은 쪽지함 - receiveId 기준.  -->
	<select id="selectNoteOfReceive" parameterType="String" resultMap="note-resultMap">
		select note_no,title,content,sendId,receiveId,sendDate,read,store
		from(
			select ceil(rownum/#{contentsPerPage) page, note_no,title,content,sendId,receiveId,sendDate,read,store
			from(
				<include refid="note-select"/>
				where receive_id=#{receiveId}
				order by send_date desc
			)
		)			
		where page = #{pageNo}
	</select>
	<!-- 보낸쪽지함 sendId 기준-->
	<select id="selectNoteOfSend" parameterType="String" resultMap="note-resultMap">
		<select id="selectNoteOfReceive" parameterType="String" resultMap="note-resultMap">
		select note_no,title,content,sendId,receiveId,sendDate,read,store
		from(
			select ceil(rownum/#{contentsPerPage) page, note_no,title,content,sendId,receiveId,sendDate,read,store
			from(
				<include refid="note-select"/>
				where send_id=#{sendId}
				order by send_date desc
			)
		)			
		where page = #{pageNo}
		
	</select>	
	<!-- 보관 쪽지함 receiveId and store 기준 -->
	<select id="selectNoteOfStore" parameterType="org.springframework.ui.Model" resultMap="product-resultMap">
		select product_id,product_name,product_price,category,product_info,image_path,regi_date,exp_date,seller_id
		from (
			select ceil(rownum/#{contentsPerPage}) page, product_id,product_name,product_price,category,product_info,image_path,regi_date,exp_date,seller_id
			from (
				<include refid="product-select"/>
				order by exp_date asc
			)
		) 
		where page = #{pageNo}
	</select>
	
	<select id="selectProductById" resultMap="product-resultMap" parameterType="org.springframework.ui.Model">
		select product_id,product_name,product_price,category,product_info,image_path,regi_date,exp_date,seller_id
		from (
			select ceil(rownum/#{contentsPerPage}) page, product_id,product_name,product_price,category,product_info,image_path,regi_date,exp_date,seller_id
			from (
				<include refid="product-select"/>
				where product_id=#{productId}
				order by exp_date asc
			)
		) 
		where page = #{pageNo}
	</select>
	
	<select id="selectProductlIKEName" resultMap="product-resultMap" parameterType="org.springframework.ui.Model">
		select product_id,product_name,product_price,category,product_info,image_path,regi_date,exp_date,seller_id
		from (
			select ceil(rownum/#{contentsPerPage}) page, product_id,product_name,product_price,category,product_info,image_path,regi_date,exp_date,seller_id
			from (
				<include refid="product-select"/>
				where product_name like '%'||#{productName}||'%'
				order by exp_date asc
			)
		) 
		where page = #{pageNo}
	</select>
	
	<select id="selectProductByCategory" resultMap="product-resultMap" parameterType="org.springframework.ui.Model">
		select product_id,product_name,product_price,category,product_info,image_path,regi_date,exp_date,seller_id
		from (
			select ceil(rownum/#{contentsPerPage}) page, product_id,product_name,product_price,category,product_info,image_path,regi_date,exp_date,seller_id
			from (
				<include refid="product-select"/>
				where category=#{category}
				order by exp_date asc
			)
		) 
		where page = #{pageNo}
	</select>
	
	<select id="selectProductByexpDate" resultMap="product-resultMap" parameterType="org.springframework.ui.Model">
		select product_id,product_name,product_price,category,product_info,image_path,regi_date,exp_date,seller_id
		from (
			select ceil(rownum/#{contentsPerPage}) page, product_id,product_name,product_price,category,product_info,image_path,regi_date,exp_date,seller_id
			from (
				<include refid="product-select"/>
				where expDate=#{expDate}
				order by exp_date asc
			)
		) 
		where page = #{pageNo}
	</select>
	
	<select id="selectProductBySellerId" resultMap="product-resultMap" parameterType="org.springframework.ui.Model">
		select product_id,product_name,product_price,category,product_info,image_path,regi_date,exp_date,seller_id
		from (
			select ceil(rownum/#{contentsPerPage}) page, product_id,product_name,product_price,category,product_info,image_path,regi_date,exp_date,seller_id
			from (
				<include refid="product-select"/>
				where seller_id=#{sellerId}
				order by exp_date asc
			)
		) 
		where page = #{pageNo}
	</select>
	
	<select id="selectProductBetweenPrice" resultMap="product-resultMap" parameterType="org.springframework.ui.Model">
		select product_id,product_name,product_price,category,product_info,image_path,regi_date,exp_date,seller_id
		from (
			select ceil(rownum/#{contentsPerPage}) page, product_id,product_name,product_price,category,product_info,image_path,regi_date,exp_date,seller_id
			from (
				<include refid="product-select"/>
				where between price #{min} and #{max}
				order by exp_date asc
			)
		) 
		where page = #{pageNo}
	</select>
	<select id="selectProductMinPrice" resultMap="product-resultMap" parameterType="org.springframework.ui.Model">
		select product_id,product_name,product_price,category,product_info,image_path,regi_date,exp_date,seller_id
		from (
			select ceil(rownum/#{contentsPerPage}) page, product_id,product_name,product_price,category,product_info,image_path,regi_date,exp_date,seller_id
			from (
				<include refid="product-select"/>
				where price &gt;= #{price}
				order by exp_date asc
			)
		) 
		where page = #{pageNo}
	</select>
	<select id="selectProductMaxPrice" resultMap="product-resultMap" parameterType="org.springframework.ui.Model">
		select product_id,product_name,product_price,category,product_info,image_path,regi_date,exp_date,seller_id
		from (
			select ceil(rownum/#{contentsPerPage}) page, product_id,product_name,product_price,category,product_info,image_path,regi_date,exp_date,seller_id
			from (
				<include refid="product-select"/>
				where price &lt;= #{price}
				order by exp_date asc
			)
		) 
		where page = #{pageNo}
	</select>
	
	<select id="selectProductCount" resultType="_int">
		select count(*)from product
	</select>
	
	<select id="selectProductCountByCategory" resultType="_int" parameterType="String">
		select count(*)from product where category=#{category}
	</select>
	
	<select id="selectProductCountlIKEName" resultType="_int" parameterType="String">
		select count(*)from product where product_name like '%'||#{productName}||'%'
	</select>
	
	<select id="selectProductToRandom" resultMap="product-resultMap" parameterType="int">
		select product_id,product_name,product_price,category,product_info,image_path,regi_date,exp_date,seller_id from (
			select product_id,product_name,product_price,category,product_info,image_path,regi_date,exp_date,seller_id from product
			order by DBMS_RANDOM.VALUE
			)
		where <![CDATA[(rownum <= #{num})]]>
	</select>
	
</mapper>
